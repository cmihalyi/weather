name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # ─────────────────────────────────────────────
  # 1. Lint & Type Check (unchanged, runs fast)
  # ─────────────────────────────────────────────
  lint-and-typecheck:
    name: Lint and Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - run: npm ci

      - name: Run ESLint
        run: npm run lint 2>&1 | tee lint-results.txt || true
        # `|| true` prevents this job from failing so the orchestrator always runs

      - name: Run TypeScript type check
        run: npx tsc --noEmit 2>&1 | tee typecheck-results.txt || true

      - uses: actions/upload-artifact@v4
        with:
          name: lint-typecheck-results
          path: |
            lint-results.txt
            typecheck-results.txt

  # ─────────────────────────────────────────────
  # 2. Tests (Vitest)
  # ─────────────────────────────────────────────
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - run: npm ci

      - name: Run Vitest
        run: npx vitest run --reporter=json --outputFile=test-results.json 2>&1 || true
        # Tests may not exist yet — always continue so orchestrator gets results

      - uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: test-results.json
          if-no-files-found: ignore

  # ─────────────────────────────────────────────
  # 3. Security — CodeQL
  # ─────────────────────────────────────────────
  security:
    name: Security Scan (CodeQL)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      security-events: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript-typescript

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          output: codeql-results
          upload: false
          # We upload manually so we can pass the SARIF to Claude

      - name: Rename SARIF for artifact upload
        run: |
          find codeql-results -name "*.sarif" | head -1 | xargs -I{} cp {} codeql-results.sarif || echo "{}" > codeql-results.sarif

      - uses: actions/upload-artifact@v4
        with:
          name: codeql-results
          path: codeql-results.sarif

  # ─────────────────────────────────────────────
  # 4. Secrets scanning — GitGuardian ggshield
  #    Runs on every push AND every PR.
  #    Scans full git history so secrets buried in
  #    old commits are caught, not just new diffs.
  # ─────────────────────────────────────────────
  secrets-scan:
    name: Secrets Scan (GitGuardian)
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # full history — required for historical secret detection

      - name: GitGuardian scan
        uses: GitGuardian/ggshield-action@v1
        env:
          GITHUB_PUSH_BEFORE_SHA: ${{ github.event.before }}
          GITHUB_PUSH_BASE_SHA: ${{ github.event.base }}
          GITHUB_PULL_BASE_SHA: ${{ github.event.pull_request.base.sha }}
          GITHUB_DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
          GITGUARDIAN_API_KEY: ${{ secrets.GITGUARDIAN_API_KEY }}

  # ─────────────────────────────────────────────
  # 5. Fetch CodeRabbit comment for Claude to read
  #    CodeRabbit posts its own review automatically;
  #    we just need to give Claude access to it.
  # ─────────────────────────────────────────────
  fetch-coderabbit:
    name: Fetch CodeRabbit Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    # Wait a bit for CodeRabbit to post its review
    # (CodeRabbit typically posts within 1–2 minutes of PR open)
    steps:
      - name: Wait for CodeRabbit
        run: sleep 90

      - name: Download PR comments
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          curl -s \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments?per_page=50" \
            > pr-comments.json

      - uses: actions/upload-artifact@v4
        with:
          name: pr-comments
          path: pr-comments.json

  # ─────────────────────────────────────────────
  # 6. AI Orchestrator — runs after all tools
  # ─────────────────────────────────────────────
  claude-orchestrator:
    name: AI CI Orchestrator
    runs-on: ubuntu-latest
    needs: [lint-and-typecheck, test, security, secrets-scan, fetch-coderabbit]
    # always() ensures this runs even when upstream jobs fail — Claude reports on failures too
    if: always() && github.event_name == 'pull_request'
    permissions:
      pull-requests: write
      contents: read
      statuses: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      # Download all tool artifacts into the working directory
      - uses: actions/download-artifact@v4
        with:
          name: lint-typecheck-results
        continue-on-error: true

      - uses: actions/download-artifact@v4
        with:
          name: test-results
        continue-on-error: true

      - uses: actions/download-artifact@v4
        with:
          name: codeql-results
        continue-on-error: true

      - uses: actions/download-artifact@v4
        with:
          name: pr-comments
        continue-on-error: true

      - name: Install AI SDK
        run: npm install @anthropic-ai/sdk
        # Replace @anthropic-ai/sdk with the relevant SDK if switching AI providers

      - name: Run CI Orchestrator
        env:
          AI_PROVIDER_API_KEY: ${{ secrets.AI_PROVIDER_API_KEY }}
          AI_MODEL: ${{ vars.AI_MODEL }}
          # AI_MODEL is a repo variable (not a secret) — set it in
          # GitHub repo Settings → Variables. Falls back to a default in the script.
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_SHA: ${{ github.event.pull_request.head.sha }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          NOTIFICATION_WEBHOOK_URL: ${{ secrets.NOTIFICATION_WEBHOOK_URL }}
          CHANGED_FILES: ${{ steps.changed-files.outputs.all_changed_files }}
        run: node .github/scripts/ai-orchestrator.js

  # ─────────────────────────────────────────────
  # 7. Deploy Preview (Vercel) — unchanged
  # ─────────────────────────────────────────────
  deploy-preview:
    name: Deploy Preview (Vercel)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4

      - uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          scope: ${{ secrets.VERCEL_ORG_ID }}

  # ─────────────────────────────────────────────
  # 8. Deploy Production — only on main push
  # ─────────────────────────────────────────────
  deploy-production:
    name: Deploy to Production (Vercel)
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: [lint-and-typecheck]
    steps:
      - uses: actions/checkout@v4

      - uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: "--prod"
          scope: ${{ secrets.VERCEL_ORG_ID }}